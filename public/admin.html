<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - PetGas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        .table-row-hover:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen bg-gray-50">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-md">
            <div class="p-6">
                <img src="https://petgasmexico-v2.vercel.app/img/hero/logoGlow.png" alt="PetGas Logo" class="w-32 mx-auto">
            </div>
            <nav class="mt-6">
                <a href="#" class="flex items-center px-6 py-2 text-gray-700 bg-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="mx-3">Dashboard</span>
                </a>
            </nav>
        </div>

        <!-- Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white border-b-2 border-gray-200">
                <h1 class="text-2xl font-semibold text-gray-700">Dashboard</h1>
                <button id="create-new-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Crear Nuevo</button>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-md shadow-md transform hover:scale-105 transition-transform duration-300">
                        <h2 class="text-lg font-semibold text-gray-700">Total de Incidencias</h2>
                        <p class="mt-2 text-3xl font-bold text-gray-900" id="total-incidents">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-md shadow-md transform hover:scale-105 transition-transform duration-300">
                        <h2 class="text-lg font-semibold text-gray-700">Quejas</h2>
                        <p class="mt-2 text-3xl font-bold text-gray-900" id="total-quejas">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-md shadow-md transform hover:scale-105 transition-transform duration-300">
                        <h2 class="text-lg font-semibold text-gray-700">Sugerencias</h2>
                        <p class="mt-2 text-3xl font-bold text-gray-900" id="total-sugerencias">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-md shadow-md transform hover:scale-105 transition-transform duration-300">
                        <h2 class="text-lg font-semibold text-gray-700">Consultas</h2>
                        <p class="mt-2 text-3xl font-bold text-gray-900" id="total-consultas">0</p>
                    </div>
                </div>

                <div class="mt-8">
                    <div id="incidents-chart"></div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-md shadow-md">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Todas las Incidencias</h2>
                    <div class="-mx-4 sm:-mx-8 px-4 sm:px-8 py-4 overflow-x-auto">
                        <div class="inline-block min-w-full shadow rounded-lg overflow-hidden">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Cliente</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Referencia</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Categoría</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table">
                                    <!-- Loading spinner -->
                                    <tr>
                                        <td colspan="5" class="text-center py-10">
                                            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold" id="modal-title">Detalles del Cliente</p>
                    <div class="modal-close cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="modal-body"></div>
                <div class="flex justify-end pt-2">
                    <button class="modal-close px-4 bg-transparent p-3 rounded-lg text-indigo-500 hover:bg-gray-100 hover:text-indigo-400 mr-2">Cerrar</button>
                    <button id="save-changes" class="px-4 bg-indigo-500 p-3 rounded-lg text-white hover:bg-indigo-400">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://cxikdsbrpvbfmqnbwawa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4aWtkc2JycHZiZm1xbmJ3YXdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxODU2OTIsImV4cCI6MjA1ODc2MTY5Mn0.5SNyKOfNyV23jfWsLVWvMnYUPiLsQ-lG56_JLoQJrfk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const tableBody = document.getElementById('data-table');
        const searchInput = document.getElementById('search');
        let allData = [];
        let chart = null;

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-10">No hay datos disponibles</td></tr>';
                return;
            }
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'table-row-hover';
                tr.innerHTML = `
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${row.nombre}</p></td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${row.referencia}</p></td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight"><span aria-hidden class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span><span class="relative">${row.categoria || 'N/A'}</span></span></td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${new Date(row.created_at).toLocaleString()}</p></td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <button onclick="openModal(${row.id})" class="text-indigo-600 hover:text-indigo-900">Ver/Editar</button>
                        <button onclick="deleteRow(${row.id})" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateDashboard(data) {
            document.getElementById('total-incidents').innerText = data.length;
            document.getElementById('total-quejas').innerText = data.filter(row => row.categoria === 'Queja').length;
            document.getElementById('total-sugerencias').innerText = data.filter(row => row.categoria === 'Sugerencia').length;
            document.getElementById('total-consultas').innerText = data.filter(row => row.categoria === 'Consulta').length;

            const options = {
                series: [{
                    name: 'Incidencias',
                    data: [
                        data.filter(row => row.categoria === 'Queja').length,
                        data.filter(row => row.categoria === 'Sugerencia').length,
                        data.filter(row => row.categoria === 'Consulta').length,
                        data.filter(row => row.categoria === 'Otro').length
                    ]
                }],
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                    },
                },
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    categories: ['Quejas', 'Sugerencias', 'Consultas', 'Otros'],
                }
            };

            if (chart) {
                chart.updateOptions(options);
            } else {
                chart = new ApexCharts(document.querySelector("#incidents-chart"), options);
                chart.render();
            }
        }

        async function fetchData() {
            const { data, error } = await supabase.from('clientes').select('*');
            if (error) {
                console.error('Error fetching data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-red-500">Error al cargar los datos</td></tr>';
                return;
            }
            allData = data;
            renderTable(allData);
            updateDashboard(allData);
        }

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = allData.filter(row => {
                    return (
                        row.nombre.toLowerCase().includes(searchTerm) ||
                        row.referencia.toLowerCase().includes(searchTerm) ||
                        (row.categoria && row.categoria.toLowerCase().includes(searchTerm))
                    );
                });
                renderTable(filteredData);
            });
        }

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const saveChangesBtn = document.getElementById('save-changes');
        let currentEditingId = null;

        function openModal(id = null) {
            currentEditingId = id;
            const isNew = id === null;
            modalTitle.innerText = isNew ? 'Crear Nuevo Registro' : 'Detalles del Cliente';
            const rowData = isNew ? {} : allData.find(row => row.id === id);

            modalBody.innerHTML = `
                <form id="edit-form">
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">Nombre</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="nombre" type="text" value="${rowData.nombre || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="email">Email</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="email" type="email" value="${rowData.email || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="telefono">Teléfono</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="telefono" type="tel" value="${rowData.telefono || ''}"></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="mensaje">Mensaje</label><textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="mensaje">${rowData.mensaje || ''}</textarea></div>
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="categoria">Categoría</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="categoria" type="text" value="${rowData.categoria || ''}"></div>
                </form>
            `;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        document.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal));
        document.querySelector('.modal-overlay').addEventListener('click', closeModal);
        document.getElementById('create-new-btn').addEventListener('click', () => openModal());

        saveChangesBtn.addEventListener('click', async () => {
            const updatedData = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                mensaje: document.getElementById('mensaje').value,
                categoria: document.getElementById('categoria').value,
            };

            let error;
            if (currentEditingId) {
                ({ error } = await supabase.from('clientes').update(updatedData).eq('id', currentEditingId));
            } else {
                ({ error } = await supabase.from('clientes').insert([updatedData]));
            }

            if (error) {
                console.error('Error saving data:', error);
                alert('Error al guardar los cambios');
            } else {
                alert('Cambios guardados con éxito');
                closeModal();
                fetchData();
            }
        });

        async function deleteRow(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este registro?')) {
                const { error } = await supabase.from('clientes').delete().eq('id', id);
                if (error) {
                    console.error('Error deleting data:', error);
                    alert('Error al eliminar el registro');
                } else {
                    alert('Registro eliminado con éxito');
                    fetchData();
                }
            }
        }

        supabase.channel('clientes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'clientes' }, payload => {
                fetchData();
            })
            .subscribe();

        fetchData();

    </script>
</body>
</html>