<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - PetGas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        #dashboard-section, #login-section { display: none; }
        .login-body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .table-header {
            background-color: #0a4b2a;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        .export-btn {
            transition: all 0.2s ease-in-out;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Glassmorphism styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 16px;
        }
        
        .glass-card-strong {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            border-radius: 16px;
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 12px;
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.55);
            border: 1px solid rgba(10, 75, 42, 0.5);
            outline: none;
        }
        
        .glass-button {
            background: rgba(10, 75, 42, 0.75);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
        }
        
        .glass-button:hover {
            background: rgba(10, 75, 42, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(10, 75, 42, 0.3);
        }
        
        .glass-button-primary {
            background: rgba(21, 128, 61, 0.85);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
        }
        
        .glass-button-primary:hover {
            background: rgba(21, 128, 61, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(21, 128, 61, 0.4);
        }
        
        .glass-table {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .glass-table-header {
            background: rgba(10, 75, 42, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-table-row:hover {
            background: rgba(255, 255, 255, 0.45);
            transition: background 0.2s ease;
        }
        
        .status-badge {
            transition: all 0.3s ease;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .filter-controls {
            transition: all 0.3s ease;
        }
        
        .filter-controls:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center min-h-screen px-4 login-body">
        <div class="w-full max-w-md p-8 space-y-6 glass-card-strong rounded-2xl shadow-2xl transform transition duration-300 hover:scale-105">
            <img src="https://petgasmexico-v2.vercel.app/img/hero/logoGlow.png" alt="PetGas Logo" class="w-32 mx-auto">
            <h2 class="text-3xl font-bold text-center text-gray-800">Acceso de Admin</h2>
            <form id="login-form" class="space-y-6">
                <div class="glass-input p-1 rounded-xl">
                    <label for="email" class="text-sm font-semibold text-gray-700 ml-3 mt-2">Email</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="block w-full px-4 py-3 mt-1 text-gray-700 bg-transparent focus:outline-none rounded-xl" placeholder="tu@email.com">
                </div>
                <div class="glass-input p-1 rounded-xl">
                    <label for="password" class="text-sm font-semibold text-gray-700 ml-3 mt-2">Contraseña</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="block w-full px-4 py-3 mt-1 text-gray-700 bg-transparent focus:outline-none rounded-xl" placeholder="********">
                </div>
                <div>
                    <button type="submit" class="w-full px-4 py-3 font-bold text-white rounded-xl glass-button-primary transform transition duration-300 hover:shadow-lg">
                        Iniciar Sesión
                    </button>
                </div>
                <p id="login-error" class="text-sm font-medium text-red-600 text-center h-4"></p>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="flex h-screen">
        <div class="w-64 bg-[#0a4b2a]/80 text-gray-100 flex flex-col backdrop-filter backdrop-blur-lg bg-opacity-80 border-r border-white/20">
            <div class="p-6 flex items-center justify-center border-b border-white/20">
                <img src="https://petgasmexico-v2.vercel.app/img/hero/logoGlow.png" alt="PetGas Logo" class="w-32">
            </div>
            <nav class="mt-6 flex-1">
                <a href="#" class="flex items-center px-6 py-3 text-gray-100 bg-green-700/70 glass-card">
                    <i class="fas fa-tachometer-alt w-6 text-center"></i>
                    <span class="mx-3">Dashboard</span>
                </a>
            </nav>
            <div class="p-6 border-t border-white/20">
                 <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-2 bg-red-500/80 text-white rounded-md hover:bg-red-600/90 glass-button transition-all duration-300">
                    <i class="fas fa-sign-out-alt w-6 text-center"></i>
                    <span class="mx-3">Cerrar Sesión</span>
                </button>
            </div>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white/30 backdrop-filter backdrop-blur-lg border-b border-white/20">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard de Incidencias</h1>
                 <div class="text-right">
                    <p class="text-sm text-gray-700">Bienvenido, <span id="user-username" class="font-medium"></span> (<span id="user-email" class="font-medium"></span>)</p>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-transparent p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card-strong p-6 rounded-xl shadow-lg flex items-center transform transition duration-300 hover:scale-105">
                        <div class="p-4 bg-green-100/70 rounded-full"><i class="fas fa-list-alt fa-2x text-green-600"></i></div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Total de Incidencias</h2>
                            <p class="mt-1 text-3xl font-bold text-gray-900" id="total-incidents">0</p>
                        </div>
                    </div>
                    <div class="glass-card-strong p-6 rounded-xl shadow-lg flex items-center transform transition duration-300 hover:scale-105">
                        <div class="p-4 bg-red-100/70 rounded-full"><i class="fas fa-exclamation-triangle fa-2x text-red-600"></i></div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Quejas</h2>
                            <p class="mt-1 text-3xl font-bold text-gray-900" id="total-quejas">0</p>
                        </div>
                    </div>
                    <div class="glass-card-strong p-6 rounded-xl shadow-lg flex items-center transform transition duration-300 hover:scale-105">
                        <div class="p-4 bg-yellow-100/70 rounded-full"><i class="fas fa-lightbulb fa-2x text-yellow-600"></i></div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Sugerencias</h2>
                            <p class="mt-1 text-3xl font-bold text-gray-900" id="total-sugerencias">0</p>
                        </div>
                    </div>
                    <div class="glass-card-strong p-6 rounded-xl shadow-lg flex items-center transform transition duration-300 hover:scale-105">
                        <div class="p-4 bg-blue-100/70 rounded-full"><i class="fas fa-question-circle fa-2x text-blue-600"></i></div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Consultas</h2>
                            <p class="mt-1 text-3xl font-bold text-gray-900" id="total-consultas">0</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 glass-card-strong p-6 rounded-xl shadow-lg">
                    <div id="incidents-chart"></div>
                </div>
                <div class="mt-8 glass-card-strong rounded-xl shadow-lg">
                    <div class="p-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Todas las Incidencias</h2>
                            <div class="flex space-x-2">
                                <button id="export-csv-btn" class="px-4 py-2 text-white rounded-md glass-button-primary flex items-center transition-all duration-300 hover:shadow-lg">
                                    <i class="fas fa-file-csv mr-2"></i>Exportar a CSV
                                </button>
                            </div>
                        </div>
                        <!-- Filter Controls -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 filter-controls">
                            <div class="glass-input p-4 rounded-xl">
                                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                                <input type="text" id="search-input" placeholder="Buscar por nombre, email, referencia..." class="w-full px-3 py-2 bg-transparent focus:outline-none">
                            </div>
                            <div class="glass-input p-4 rounded-xl">
                                <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                                <select id="category-filter" class="w-full px-3 py-2 bg-transparent focus:outline-none">
                                    <option value="">Todas</option>
                                    <option value="Queja">Queja</option>
                                    <option value="Sugerencia">Sugerencia</option>
                                    <option value="Consulta">Consulta</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="glass-input p-4 rounded-xl">
                                <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Ordenar por fecha</label>
                                <select id="date-filter" class="w-full px-3 py-2 bg-transparent focus:outline-none">
                                    <option value="desc">Más reciente primero</option>
                                    <option value="asc">Más antiguo primero</option>
                                </select>
                            </div>
                            <div class="glass-input p-4 rounded-xl">
                                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                <select id="status-filter" class="w-full px-3 py-2 bg-transparent focus:outline-none">
                                    <option value="">Todos</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Resuelto">Resuelto</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="-mx-4 sm:-mx-8 px-4 sm:px-8 pb-4 overflow-x-auto">
                        <div class="inline-block min-w-full align-middle">
                            <table class="glass-table min-w-full leading-normal">
                                <thead class="glass-table-header">
                                    <tr>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Cliente</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Referencia</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Categoría</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Estado</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Asignado a</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Fecha</th>
                                        <th class="px-5 py-3 border-b border-white/20 text-left text-xs font-semibold text-gray-100 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="details-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/50 backdrop-filter backdrop-blur-sm"></div>
        <div class="modal-container glass-card-strong w-11/12 md:max-w-3xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform transition-all duration-300 scale-95">
            <div class="modal-content py-6 text-left px-6">
                <div class="flex justify-between items-center pb-4 border-b border-white/20">
                    <p class="text-2xl font-bold text-gray-800">Detalles de la Incidencia</p>
                    <div class="modal-close cursor-pointer z-50">
                        <svg class="fill-current text-gray-700 hover:text-gray-900 transition-colors duration-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="modal-body" class="my-5"></div>
                <div class="flex justify-end pt-4 border-t border-white/20">
                    <button class="modal-close px-6 py-3 bg-gray-200/70 glass-button rounded-lg text-gray-800 hover:bg-gray-300/80 transition-all duration-300">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        // Use the same origin as the frontend, but ensure we're using the correct port
        const API_BASE_URL = window.location.origin;
        console.log('API Base URL:', API_BASE_URL); // Debug log
        
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const tableBody = document.getElementById('data-table');
        const userEmailSpan = document.getElementById('user-email');
        const userUsernameSpan = document.getElementById('user-username');
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const dateFilter = document.getElementById('date-filter');
        const statusFilter = document.getElementById('status-filter');
        let chart = null;
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let users = []; // Array to store list of users

        function showLogin() {
            document.body.classList.add('login-body');
            loginSection.style.display = 'flex';
            dashboardSection.style.display = 'none';
        }

        function showDashboard() {
            document.body.classList.remove('login-body');
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'flex';
        }

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        async function fetchData() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showLogin();
                return;
            }

            const userData = parseJwt(token);
            if (userData && userData.email) {
                userEmailSpan.textContent = userData.email;
                if (userData.username) {
                    userUsernameSpan.textContent = userData.username;
                } else {
                    userUsernameSpan.textContent = userData.email;
                }
            }

            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-10"><div class="flex justify-center"><div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div></div></td></tr>';

            try {
                // Fetch incidents data
                const incidentsResponse = await fetch(`${API_BASE_URL}/api/admin/data`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (incidentsResponse.status === 401 || incidentsResponse.status === 403) {
                    localStorage.removeItem('authToken');
                    showLogin();
                    loginError.textContent = 'Sesión expirada. Por favor, inicia sesión de nuevo.';
                    return;
                }

                if (!incidentsResponse.ok) {
                    throw new Error('Error al cargar los datos de incidentes.');
                }

                const incidentsData = await incidentsResponse.json();
                allData = incidentsData;
                filteredData = [...incidentsData]; // Initialize filteredData with all data

                // Fetch users data
                const usersResponse = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (usersResponse.status === 401 || usersResponse.status === 403) {
                    localStorage.removeItem('authToken');
                    showLogin();
                    loginError.textContent = 'Sesión expirada. Por favor, inicia sesión de nuevo.';
                    return;
                }

                if (!usersResponse.ok) {
                    throw new Error('Error al cargar los datos de usuarios.');
                }

                const usersData = await usersResponse.json();
                users = usersData;

                // Apply filters and render
                applyFilters();
                updateDashboardStats(incidentsData);
                showDashboard();

            } catch (error) {
                console.error('Error fetching data:', error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-red-500">${error.message}</td></tr>`;
            }
        }

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            const dateOrder = dateFilter.value;
            const status = statusFilter.value;
            
            filteredData = allData.filter(row => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    row.nombre.toLowerCase().includes(searchTerm) ||
                    row.email.toLowerCase().includes(searchTerm) ||
                    row.referencia.toLowerCase().includes(searchTerm) ||
                    (row.mensaje && row.mensaje.toLowerCase().includes(searchTerm));
                
                // Category filter
                const matchesCategory = !category || row.categoria === category;
                
                // Status filter
                const matchesStatus = !status || (row.response_status || 'Pendiente') === status;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            // Sort by date
            filteredData.sort((a, b) => {
                const dateA = new Date(a.created_at);
                const dateB = new Date(b.created_at);
                return dateOrder === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            // Reset to first page and render
            currentPage = 1;
            renderTable(filteredData);
            renderPagination();
        }
        
        function renderTable(data) {
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = data.slice(startIndex, endIndex);
            
            tableBody.innerHTML = '';
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-10">No hay datos disponibles</td></tr>';
                return;
            }
            
            pageData.forEach(row => {
                // Get response status or default to 'Pendiente'
                const responseStatus = row.response_status || 'Pendiente';
                
                // Get assigned user or default to 'Sin asignar'
                const assignedTo = row.responded_by || 'Sin asignar';
                
                // Determine status icon and color
                let statusIcon, statusColor, statusBgColor;
                switch(responseStatus) {
                    case 'Pendiente':
                        statusIcon = 'far fa-clock';
                        statusColor = 'text-gray-700';
                        statusBgColor = 'bg-gray-200';
                        break;
                    case 'En Progreso':
                        statusIcon = 'fas fa-sync-alt';
                        statusColor = 'text-blue-700';
                        statusBgColor = 'bg-blue-200';
                        break;
                    case 'Resuelto':
                        statusIcon = 'fas fa-check-circle';
                        statusColor = 'text-green-700';
                        statusBgColor = 'bg-green-200';
                        break;
                    case 'Cerrado':
                        statusIcon = 'fas fa-times-circle';
                        statusColor = 'text-red-700';
                        statusBgColor = 'bg-red-200';
                        break;
                    default:
                        statusIcon = 'far fa-question-circle';
                        statusColor = 'text-gray-700';
                        statusBgColor = 'bg-gray-200';
                }
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${row.nombre}</p></td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${row.referencia}</p></td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm"><span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight"><span aria-hidden class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span><span class="relative">${row.categoria || 'N/A'}</span></span></td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm">
                        <span class="relative inline-block px-3 py-1 font-semibold ${statusColor} leading-tight">
                            <span aria-hidden class="absolute inset-0 ${statusBgColor} opacity-50 rounded-full"></span>
                            <span class="relative"><i class="${statusIcon} mr-1"></i>${responseStatus}</span>
                        </span>
                    </td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${assignedTo}</p></td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${new Date(row.created_at).toLocaleString()}</p></td>
                    <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm">
                        <button onclick="openModal(${row.id})" class="text-green-600 hover:text-green-900 font-semibold">Ver Detalles</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages <= 1) return;
            
            let paginationHtml = `
                <div class="flex items-center justify-between border-t border-white/20 bg-white/20 px-4 py-3 sm:px-6 rounded-b-2xl backdrop-filter backdrop-blur-sm">
                    <div class="flex flex-1 justify-between sm:hidden">
                        <button onclick="changePage(${currentPage > 1 ? currentPage - 1 : 1})" class="relative inline-flex items-center rounded-md border border-white/30 bg-white/30 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-white/50 glass-button transition-all duration-300">Anterior</button>
                        <button onclick="changePage(${currentPage < totalPages ? currentPage + 1 : totalPages})" class="relative ml-3 inline-flex items-center rounded-md border border-white/30 bg-white/30 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-white/50 glass-button transition-all duration-300">Siguiente</button>
                    </div>
                    <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Mostrando <span class="font-medium">${(currentPage - 1) * itemsPerPage + 1}</span> a <span class="font-medium">${Math.min(currentPage * itemsPerPage, filteredData.length)}</span> de <span class="font-medium">${filteredData.length}</span> resultados
                            </p>
                        </div>
                        <div>
                            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                                <button onclick="changePage(${currentPage > 1 ? currentPage - 1 : 1})" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-gray-700 ring-1 ring-inset ring-white/30 hover:bg-white/30 glass-button transition-all duration-300">
                                    <span class="sr-only">Anterior</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                                    </svg>
                                </button>
            `;
            
            // Generate page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHtml += `<span class="relative z-10 inline-flex items-center bg-green-600/80 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600 glass-button rounded-none">${i}</span>`;
                } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `<button onclick="changePage(${i})" class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-white/30 hover:bg-white/30 glass-button rounded-none transition-all duration-300">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += `<span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-white/30 focus:outline-offset-0">...</span>`;
                }
            }
            
            paginationHtml += `
                                <button onclick="changePage(${currentPage < totalPages ? currentPage + 1 : totalPages})" class="relative inline-flex items-center rounded-r-md px-3 py-2 text-gray-700 ring-1 ring-inset ring-white/30 hover:bg-white/30 glass-button transition-all duration-300">
                                    <span class="sr-only">Siguiente</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            `;
            
            // Add pagination after the table
            const tableContainer = tableBody.closest('.inline-block.min-w-full.align-middle');
            if (tableContainer.nextElementSibling && tableContainer.nextElementSibling.classList.contains('pagination-container')) {
                tableContainer.nextElementSibling.innerHTML = paginationHtml;
            } else {
                const paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination-container';
                paginationContainer.innerHTML = paginationHtml;
                tableContainer.parentNode.insertBefore(paginationContainer, tableContainer.nextSibling);
            }
        }
        
        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTable(filteredData);
            renderPagination();
            
            // Scroll to top of table
            document.querySelector('.mt-8.bg-white.rounded-xl.shadow-md').scrollIntoView({ behavior: 'smooth' });
        }

        function openModal(id) {
            const incident = allData.find(row => row.id === id);
            if (!incident) return;

            // Get current values or defaults
            const responseStatus = incident.response_status || 'Pendiente';
            const respondedBy = incident.responded_by || 'Sin asignar';
            const responseDate = incident.response_date ? new Date(incident.response_date).toLocaleString() : 'Sin fecha';
            const responseMessage = incident.response_message || '';

            // Generate users dropdown options
            let usersOptions = '<option value="">Seleccionar usuario...</option>';
            users.forEach(user => {
                const userDisplay = user.username || user.email;
                const isSelected = respondedBy === userDisplay ? 'selected' : '';
                usersOptions += `<option value="${userDisplay}" ${isSelected}>${userDisplay}</option>`;
            });

            modalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Nombre</p><p class="text-gray-800">${incident.nombre}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Email</p><p class="text-gray-800">${incident.email}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Teléfono</p><p class="text-gray-800">${incident.telefono || 'No proporcionado'}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Referencia</p><p class="text-gray-800">${incident.referencia}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Categoría</p><p class="text-gray-800">${incident.categoria || 'N/A'}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Fecha de Creación</p><p class="text-gray-800">${new Date(incident.created_at).toLocaleString()}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Estado de Respuesta</p><p class="text-gray-800">${responseStatus}</p></div>
                    <div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Atendido por</p><p class="text-gray-800">${respondedBy}</p></div>
                    ${responseDate !== 'Sin fecha' ? `<div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Fecha de Respuesta</p><p class="text-gray-800">${responseDate}</p></div>` : ''}
                    <div class="md:col-span-2 bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-gray-500">Mensaje</p><p class="text-gray-800 whitespace-pre-wrap">${incident.mensaje}</p></div>
                    ${responseMessage ? `<div class="md:col-span-2 bg-blue-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Respuesta</p><p class="text-gray-800 whitespace-pre-wrap">${responseMessage}</p></div>` : ''}
                </div>
                
                <!-- Response Update Form -->
                <div class="mt-6 p-4 bg-gray-50/50 glass-card rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Actualizar Estado de Respuesta</h3>
                    <form id="response-form" class="space-y-4">
                        <input type="hidden" id="incident-id-status" value="${id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="response-status" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                <select id="response-status" class="w-full px-3 py-2 glass-input rounded-lg focus:outline-none">
                                    <option value="Pendiente" ${responseStatus === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="En Progreso" ${responseStatus === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                                    <option value="Resuelto" ${responseStatus === 'Resuelto' ? 'selected' : ''}>Resuelto</option>
                                    <option value="Cerrado" ${responseStatus === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                                </select>
                            </div>
                            <div>
                                <label for="responded-by" class="block text-sm font-medium text-gray-700 mb-1">Asignado a</label>
                                <select id="responded-by" class="w-full px-3 py-2 glass-input rounded-lg focus:outline-none">
                                    ${usersOptions}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="response-message" class="block text-sm font-medium text-gray-700 mb-1">Mensaje de Respuesta</label>
                            <textarea id="response-message" rows="3" placeholder="Escribe la respuesta aquí..." class="w-full px-3 py-2 glass-input rounded-lg focus:outline-none">${responseMessage}</textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200/70 glass-button rounded-lg hover:bg-gray-300/80">Cancelar</button>
                            <button type="submit" class="px-4 py-2 text-white glass-button-primary rounded-lg">Actualizar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Email Response Form -->
                <div class="mt-6 p-4 bg-gray-50/50 glass-card rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Responder por Email</h3>
                    <form id="email-response-form" class="space-y-4">
                        <input type="hidden" id="incident-id-email" value="${id}">
                        <div>
                            <label for="response-subject" class="block text-sm font-medium text-gray-700 mb-1">Asunto</label>
                            <input type="text" id="response-subject" value="Respuesta a su solicitud: ${incident.referencia}" class="w-full px-3 py-2 glass-input rounded-lg focus:outline-none">
                        </div>
                        <div>
                            <label for="response-message-email" class="block text-sm font-medium text-gray-700 mb-1">Mensaje</label>
                            <textarea id="response-message-email" rows="4" placeholder="Escriba su respuesta aquí..." class="w-full px-3 py-2 glass-input rounded-lg focus:outline-none"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200/70 glass-button rounded-lg hover:bg-gray-300/80">Cancelar</button>
                            <button type="submit" class="px-4 py-2 text-white glass-button-primary rounded-lg flex items-center">
                                <i class="fas fa-paper-plane mr-2"></i> Enviar Respuesta
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Add event listeners to both forms
            const responseForm = document.getElementById('response-form');
            const emailResponseForm = document.getElementById('email-response-form');
            
            if (responseForm) {
                responseForm.addEventListener('submit', updateResponseStatus);
            }
            
            if (emailResponseForm) {
                emailResponseForm.addEventListener('submit', sendEmailResponse);
            }
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        // Function to handle response status update
        async function updateResponseStatus(event) {
            event.preventDefault();
            
            const form = event.target;
            const id = document.getElementById('incident-id-status').value;
            const responseStatus = document.getElementById('response-status').value;
            const respondedBy = document.getElementById('responded-by').value;
            const responseMessage = document.getElementById('response-message').value;
            
            // Get auth token
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                showLogin();
                return;
            }
            
            try {
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = 'Actualizando...';
                submitButton.disabled = true;
                
                // Send update request
                const url = `${API_BASE_URL}/api/admin/incidents/${id}`;
                console.log('Sending request to:', url); // Debug log
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        response_status: responseStatus,
                        responded_by: respondedBy,
                        response_message: responseMessage
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error al actualizar el incidente');
                }
                
                // Update local data
                const incidentIndex = allData.findIndex(item => item.id == id);
                if (incidentIndex !== -1) {
                    allData[incidentIndex] = { ...allData[incidentIndex], ...result.incident };
                }
                
                // Re-apply filters to update the view
                applyFilters();
                
                // Close modal and show success message
                closeModal();
                alert('Incidente actualizado exitosamente');
                
            } catch (error) {
                console.error('Error updating incident:', error);
                alert(`Error: ${error.message}`);
            } finally {
                // Reset loading state
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.innerHTML = 'Actualizar';
                submitButton.disabled = false;
            }
        }
        
        // Function to send email response
        async function sendEmailResponse(event) {
            event.preventDefault();
            
            const form = event.target;
            const id = document.getElementById('incident-id-email').value;
            const responseSubject = document.getElementById('response-subject').value;
            const responseMessage = document.getElementById('response-message-email').value;
            
            // Get auth token
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                showLogin();
                return;
            }
            
            // Validate message
            if (!responseMessage.trim()) {
                alert('Por favor, escriba un mensaje de respuesta.');
                return;
            }
            
            try {
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.innerHTML = 'Enviando...';
                submitButton.disabled = true;
                
                // Send email response request
                const response = await fetch(`${API_BASE_URL}/api/admin/incidents/${id}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        response_message: responseMessage,
                        response_subject: responseSubject
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error al enviar la respuesta');
                }
                
                // Update local data
                const incidentIndex = allData.findIndex(item => item.id == id);
                if (incidentIndex !== -1) {
                    allData[incidentIndex] = { ...allData[incidentIndex], ...result.incident };
                }
                
                // Re-apply filters to update the view
                applyFilters();
                
                // Close modal and show success message
                closeModal();
                alert('Respuesta enviada exitosamente al cliente');
                
            } catch (error) {
                console.error('Error sending email response:', error);
                alert(`Error: ${error.message}`);
            } finally {
                // Reset loading state
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.innerHTML = 'Enviar Respuesta';
                submitButton.disabled = false;
            }
        }

        document.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal));
        const modalOverlay = document.querySelector('.modal-overlay');
        if(modalOverlay) modalOverlay.addEventListener('click', closeModal);

        function updateDashboardStats(data) {
            document.getElementById('total-incidents').innerText = data.length;
            const quejas = data.filter(row => row.categoria === 'Queja').length;
            const sugerencias = data.filter(row => row.categoria === 'Sugerencia').length;
            const consultas = data.filter(row => row.categoria === 'Consulta').length;
            const otros = data.filter(row => !row.categoria || !['Queja', 'Sugerencia', 'Consulta'].includes(row.categoria)).length;

            document.getElementById('total-quejas').innerText = quejas;
            document.getElementById('total-sugerencias').innerText = sugerencias;
            document.getElementById('total-consultas').innerText = consultas;

            const options = {
                series: [{ name: 'Incidencias', data: [quejas, sugerencias, consultas, otros] }],
                chart: { type: 'bar', height: 350, toolbar: { show: false } },
                colors: ['#EF4444', '#FBBF24', '#3B82F6', '#6B7280'],
                plotOptions: { bar: { horizontal: false, columnWidth: '55%', distributed: true, borderRadius: 8 } },
                dataLabels: { enabled: false },
                legend: { show: false },
                xaxis: { categories: ['Quejas', 'Sugerencias', 'Consultas', 'Otros'] },
                yaxis: { title: { text: 'Cantidad' } },
                grid: { borderColor: '#f1f1f1' }
            };

            if (chart) {
                chart.updateOptions(options);
            } else {
                chart = new ApexCharts(document.querySelector("#incidents-chart"), options);
                chart.render();
            }
        }
        
        function exportToCSV() {
            const headers = ['ID', 'Nombre', 'Email', 'Telefono', 'Mensaje', 'Referencia', 'Categoria', 'Fecha Creacion'];
            const rows = allData.map(row => [
                row.id,
                `"${row.nombre}"`,
                `"${row.email}"`,
                `"${row.telefono || ''}"`,
                `"${(row.mensaje || '').replace(/"/g, "'")}"`,
                `"${row.referencia}"`,
                `"${row.categoria || 'N/A'}"`,
                `"${new Date(row.created_at).toISOString()}"`
            ]);

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "incidencias_petgas.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = e.target.email.value;
            const password = e.target.password.value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error en el inicio de sesión');
                }

                localStorage.setItem('authToken', result.token);
                fetchData();

            } catch (error) {
                console.error('Login failed:', error);
                loginError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            showLogin();
        });

        exportCsvBtn.addEventListener('click', exportToCSV);
        
        // Add event listeners for filter controls
        searchInput.addEventListener('input', applyFilters);
        categoryFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (token) {
                fetchData();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>